<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <title>Requests Pending Approval</title>
</head>
<body>

    <div class="container">
        <h1>Requests</h1>

    <button onclick="getPendingRequests()" type="button" class="btn btn-primary">View Pending Requests</button>

    <div id="result">
        <table class="table">

            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Urgent</th>
                <th scope="col">Super Approval</th>
                <th scope="col">Dept Approval</th>
                <th scope="col">BenCo Approval</th>
                <th scope="col">Location</th>
                <th scope="col">Event Type</th>
                <th scope="col">Grade</th>
                <th scope="col">Amount Requested</th>
                <th scope="col">Amount Approved</th>
                <th scope="col">Approve</th>

              </tr>
            </thead>

            <tbody id="tableRow">

            </tbody>
          </table>

    </div>
    <p id="success"></p>


    </div>
    
</body>

<script>
        let emp = localStorage.getItem("title");
        console.log(emp)
    function getPendingRequests() {

        
        // console.log(emp.title);

    
            let xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 & this.status == 200) {
                    console.log(this.responseText)
                    if (this.responseText == "{}" || this.responseText == "[]") {
                        document.getElementById("success").innerHTML = "No pending requests to approve"
                    }
                    // console.log(this.response)
                    let requests = JSON.parse(this.responseText)
                    console.log(requests);

    
                    const tableRow = document.getElementById("tableRow")
                    tableRow.innerHTML = "";
                    let count = 1;
    
                    // <th scope="col">Super Approval</th>
                    // <th scope="col">Dept Approval</th>
                    // <th scope="col">BenCo Approval</th>
                    // <th scope="col">Location</th>
                    // <th scope="col">Event Type</th>
                    // <th scope="col">Amount Request</th>
                    // <th scope="col">Amount Approve</th>
    
                    requests.forEach(res => {
    
                        var content = `
                            <tr>
                                <th scope="row">${count}</th>
                                <td>${res.urgent}</td>
                                <td>${res.superAppve}</td>
                                <td>${res.deptAppve}</td>
                                <td>${res.benCoAppve}</td>
                                <td>${res.form.location}</td>
                                <td>${res.form.eventType}</td>
                                <td>${res.grade}</td>
                                <td>${res.form.cost}</td>
                                <td>${res.amountAppve}</td>
                           
                             `

                        if (emp == "BenCo") {
                            content += `
                            </tr>
                            <label> Approve Higher Amount (optional) </label>
                            <input id="inputAmount${res.id}" type='number'/>
                            <label> Reason </label>
                            <input id="inputReason${res.id}" type='text' value="reason for increase"/>
                            <button onclick="approveRequest(${res.id})" type="button" class="btn btn-primary">Approve</button></td>
                            
                            `
                        } else {
                            content += `
                            <td><button onclick="approveRequest(${res.id})" type="button" class="btn btn-primary">Approve</button></td>

                        </tr>
            
                            `
                        }

                        tableRow.innerHTML += content;
                        count += 1;
                    })
                }

                if (this.readyState == 4 & this.status != 200) {
                    document.getElementById("success").innerHTML = "No pending requests to approve"
                }
            };
    
            let url = `http://localhost:7000/employees/requests/pending`
            xhr.open("GET", url, true);
            xhr.send();
            
        }

        function approveRequest(id) {

            // if (!amount) {
            //     amount = 0
            // }

            let xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function() {
                if (this.readyState == 4 & this.status == 200) {
                    document.getElementById("success").innerHTML = "Request approved"
                }
            }

            let url = "http://localhost:7000/employees/requests/pending/approve"

            xhr.open("POST", url, true)

            xhr.setRequestHeader('Content-Type', "application/json");

            if (emp == "BenCo") {
                let amount = document.getElementById("inputAmount"+id).value;
                let reason = document.getElementById("inputReason"+id).value;

                let GetJsonId = {
                    id: id,
                    amount: amount,
                    reason: reason
                }
                xhr.send(JSON.stringify(GetJsonId));

            } else {
                let GetJsonId = {
                    id: id,
                }
                xhr.send(JSON.stringify(GetJsonId));

            }

        }
    
    </script>
</html>